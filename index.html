<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PZEM - Monitoring</title>

  <!-- Canvas Gauges (versi yang berfungsi) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-gauges@2.1.7/gauge.min.js"></script>

  <!-- Paho MQTT -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

  <style>
    body {
      background: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .gauge-box {
      text-align: center;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
  </style>
</head>
<body>

  <h2>PZEM Real-Time Monitoring </h2>
  <h2>Kelas Elektronika Daya - 2025 </h2>

  <div class="container">
    <!-- Volt -->
    <div class="gauge-box">
      <canvas id="gaugeVolt" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="0"
        data-max-value="300"
        data-major-ticks="0,50,100,150,200,250,300"
        data-units="V"
        data-title="Tegangan"
        data-value="0"
        data-color-value="#FF5722"
        data-glow="true">
      </canvas>
    </div>

    <!-- Arus -->
    <div class="gauge-box">
      <canvas id="gaugeArus" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="0"
        data-max-value="100"
        data-major-ticks="0,10,20,30,40,50,60,70,80,90,100"
        data-units="A"
        data-title="Arus"
        data-value="0"
        data-color-value="#2196F3"
        data-glow="true">
      </canvas>
    </div>

    <!-- Daya -->
    <div class="gauge-box">
      <canvas id="gaugeDaya" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="0"
        data-max-value="10000"
        data-major-ticks="0,2000,4000,6000,8000,10000"
        data-units="W"
        data-title="Daya"
        data-value="0"
        data-color-value="#4CAF50"
        data-glow="true">
      </canvas>
    </div>

    <!-- kWh -->
    <div class="gauge-box">
      <canvas id="gaugeKwh" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="0"
        data-max-value="100"
        data-major-ticks="0,10,20,30,40,50,60,70,80,90,100"
        data-units="kWh"
        data-title="Energi"
        data-value="0"
        data-color-value="#FF9800"
        data-glow="true">
      </canvas>
    </div>

    <!-- Frekuensi -->
    <div class="gauge-box">
      <canvas id="gaugeFrek" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="40"
        data-max-value="60"
        data-major-ticks="40,45,50,55,60"
        data-units="Hz"
        data-title="Frekuensi"
        data-value="50"
        data-color-value="#9C27B0"
        data-glow="true">
      </canvas>
    </div>

    <!-- PF -->
    <div class="gauge-box">
      <canvas id="gaugePf" data-type="radial-gauge"
        data-width="220"
        data-height="220"
        data-min-value="0"
        data-max-value="1"
        data-major-ticks="0,0.2,0.4,0.6,0.8,1.0"
        data-units=""
        data-title="Power Factor"
        data-value="0"
        data-color-value="#795548"
        data-glow="true">
      </canvas>
    </div>
  </div>

  <script>
    // Tunggu DOM dan gauge siap
    window.addEventListener('load', () => {
      // Tunda sebentar agar canvas-gauges selesai inisialisasi
      setTimeout(() => {
        // Ambil semua gauge instance (canvas-gauges menyimpan di window.gauges)
        const gauges = window.gauges || [];
        if (gauges.length < 6) {
          console.error("Gauge tidak terinisialisasi dengan benar");
          return;
        }

        // Urutan sesuai urutan <canvas> di HTML
        const gaugeVolt = gauges[0];
        const gaugeArus = gauges[1];
        const gaugeDaya = gauges[2];
        const gaugeKwh  = gauges[3];
        const gaugeFrek = gauges[4];
        const gaugePf   = gauges[5];

        // === MQTT Setup ===
        const client = new Paho.MQTT.Client("test.mosquitto.org", 8081, "/mqtt", "elkadaya-" + Date.now());

        client.onConnectionLost = (responseObject) => {
          console.log("Koneksi MQTT terputus:", responseObject.errorMessage);
        };

        client.onMessageArrived = (message) => {
          try {
            const data = JSON.parse(message.payloadString);
            // Update nilai gauge
            if (gaugeVolt) gaugeVolt.value = data.volt || 0;
            if (gaugeArus) gaugeArus.value = data.arus || 0;
            if (gaugeDaya) gaugeDaya.value = data.daya || 0;
            if (gaugeKwh)  gaugeKwh.value  = data.kwh  || 0;
            if (gaugeFrek) gaugeFrek.value = data.frek || 50;
            if (gaugePf)   gaugePf.value   = data.pf   || 0;
          } catch (e) {
            console.error("Error parsing MQTT message:", e);
          }
        };

        client.connect({
          useSSL: true, // <-- wajib true jika buka dari https:// atau localhost via Live Server
          onSuccess: () => {
            console.log("✅ Terhubung ke MQTT");
            client.subscribe("/aisi555/pzem"); //subscribe ke TOPIK
          },
          onFailure: (err) => {
            console.error("❌ Gagal terhubung ke MQTT:", err);
          }
        });

      }, 800); // Tunggu 800ms agar gauge siap
    });
  </script>
</body>
</html>
